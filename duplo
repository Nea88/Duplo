#/!/bin/bash
set -e; 

WP_SOURCE="https://github.com/Nea88/wordpress-skeleton.git"
DOCPAD_SOURCE="https://github.com/Nea88/docpad-duplo.git"
CONF_DIR="$HOME/.duplo"

if [ ! $1 ]; then
    duplo help
    exit 0
fi

if [ $1 != "config:set" ] && [ $1 != "config:get" ] && [ $1 != "help" ]; then
    if [ ! -f "$CONF_DIR/user" ]; then
        echo "----! User name not setted, please use duplo config:set user %user_name% or duplo help"
        exit 0
    else
        USER_NAME=$(cat "$CONF_DIR/user")
    fi
fi

GET_PROJECT_STUB()
{
    git clone $1 $2
}

case "$1" in

  create)
    if [ -z $2 ]; then
        echo "----! You must specify an app type"
        exit 1
    else
        if [ -z $3 ]; then
            echo "----! You must specify an app type"
            exit 1
    	else
            if [ -d "./$3" ]; then
                echo "---->App is already exist"
    	        exit 1
   	        else
                APP=$3
                case $2 in
                    wp)
            	       GET_PROJECT_STUB $WP_SOURCE $APP
            	       cd $APP
	                   echo "/home/dokku/.storages/$APP:/app/content/uploads:rw">PERSISTENT_STORAGE

	                   git add PERSISTENT_STORAGE
	                   git commit -m 'Added persistent storage files'
                   ;;
                   docpad)
                       GET_PROJECT_STUB $DOCPAD_SOURCE $APP
                       cd $APP
	                   docpad init
	                   git add .
	                   git commit -m 'Initial'
                   ;;
                   other)
                      mkdir $APP
                      cd $APP
                      git init
                   ;;
                   *)
                        echo "----! Unknown app type"
                        exit 0
                    ;;
                esac


                echo $APP>PROJECT_NAME
	            git add PROJECT_NAME
	            git commit -m 'Added project name file'

                echo "----> $APP created"
            fi
        fi
   fi
  ;;

  config:set)
    if [ -z $2 ]; then
        echo "----! You must specify type"
        exit 1
    fi
    if [ $2 = '--global' ] && [ -z $3 ] || [ $2 != 'user' ]; then
        TYPE=$3
        PARAM=$4
        SAVE_DIR="./.duplo"
    else
        TYPE=$2
        PARAM=$3
        SAVE_DIR=$CONF_DIR
    fi

    if [ $TYPE != "dev" ] && [ $TYPE != "testing" ] && [ $TYPE != "prod" ] && [ $TYPE != "user" ]; then
        echo "----! Unknown config type"
    fi

    if [ -z $PARAM ]; then
        echo "----! You must specify param"
        exit 1
    fi

    if [ ! -d $SAVE_DIR ]; then
        mkdir -p $SAVE_DIR
    fi
    
    echo $PARAM > $SAVE_DIR/$TYPE
  ;;

  config:get)
    if [ -z $2 ]; then
        echo "----! You must specify type"
        exit 1
    fi
    TYPE=$2
    if [ $TYPE != "dev" ] && [ $TYPE != "testing" ] && [ $TYPE != "prod" ] && [ $TYPE != "user" ]; then
        echo "----! Unknown config type"
    fi
    
    if [ -d './.duplo' ]; then
        if [ ! -f "./.duplo/$TYPE" ];then
            CONF=$(cat "$CONF_DIR/$TYPE")
            echo "$CONF"
            exit 0
        fi
    fi
    
    if [ ! -f "$CONF_DIR/$TYPE" ]; then
        echo "no params"
        exit 0;
    fi
    CONF=$(cat "$CONF_DIR/$TYPE")
    echo "$CONF"
  ;;

  deploy:dev)
    APP=$(cat PROJECT_NAME)
    git remote show dev || if [ $(duplo config:get dev)!='no params' ]; then
        git remote add dev dokku@$(duplo config:get dev):$APP-$USER_NAME
    else
        echo "----! Please set dev url!"
        exit 0
    fi

    if [ -f "./wp-config.php" ]; then
        sed -i "s|^define('WP_HOME'.*|define('WP_HOME', 'http://$APP-$USER_NAME.tadatuta.org');|" wp-config.php
        sed -i "s|^define('WP_SITEURL'.*|define('WP_SITEURL', 'http://$APP-$USER_NAME.tadatuta.org/wp');|" wp-config.php
        
        git add wp-config.php
        git commit -m 'Changed url to dev' || echo "----> Dev urls'"

    fi
    
    if [ -f "./DOMAINS" ]; then
        git rm DOMAINS
        git commit -m 'domains file cant be in dev'
        echo "Removed domains file"
    fi

    git push dev master
  ;;

  deploy:testing)
    APP=$(cat PROJECT_NAME)

    git remote show testing || if [ $(duplo config:get testing)!='no params' ]; then
        git remote add testing dokku@$(duplo config:get testing):$APP-testing
    else
        echo "----! Please set testing url!"
        exit 0
    fi

    if [ -f "./wp-config.php" ]; then
        sed -i "s|^define('WP_HOME'.*|define('WP_HOME', 'http://$APP-testing.tadatuta.org/wp');|" wp-config.php
        sed -i "s|^define('WP_SITEURL'.*|define('WP_SITEURL', 'http://$APP-testing.tadatuta.org');|" wp-config.php

        git add wp-config.php
        git commit -m 'Changed url to testing' || echo "----> Testing urls'"
    fi

    if [ -f "./DOMAINS" ]; then
        git rm DOMAINS
        git commit -m 'domains file cant be in dev'
        echo "Removed domains file"
    fi
    git push testing master
  ;;

  deploy:prod)
    if [ -z $2 ]; then
        echo "----! You must specify domains"
        exit 0
    fi

    APP=$(cat PROJECT_NAME)
    git remote show prod || if [ $(duplo config:get prod)!='no params' ]; then
        git remote add dev dokku@$(duplo config:get prod):$APP-prod
    else
        echo "----! Please set production url!"
        exit 0
    fi

    if [ -f "./wp-config.php" ]; then
        sed -i "s|^define('WP_HOME'.*|define('WP_HOME', 'http://$2/wp');|" wp-config.php
        sed -i "s|^define('WP_SITEURL'.*|define('WP_SITEURL', 'http://$2');|" wp-config.php

        git add wp-config.php
        git commit -m 'Changed url to production' || echo "----> Production urls'"
    fi

    echo $2 > DOMAINS
    git add "./DOMAINS"
    git commit -m 'domains file added'
    echo "Added domains file"
    git push prod master
  ;;
  
  deploy)
    if [ -z $2 ]; then
        echo "----! You must specify domain"
        exit 0
    fi

    APP=$(cat PROJECT_NAME)
    git remote add custom dokku@$2:$3

    if [ -f "./wp-config.php" ]; then
        if [ -z $3 ]; then
            echo "----! Specifi site domain"
            exit 0
        fi

        sed -i "s|^define('WP_HOME'.*|define('WP_HOME', 'http://$3/wp');|" wp-config.php
        sed -i "s|^define('WP_SITEURL'.*|define('WP_SITEURL', 'http://$3');|" wp-config.php

        git add wp-config.php
        git commit -m 'Changed url to production' || echo "----> Production urls'"
    fi
    git push custom master
    git remote rm custom
  ;;

  help)   
    echo "duplo config:set <type> <url|name>      type - <dev|testing|user|prod>  ---global - to set global params"
    echo "duplo config:get <type>                 type - <dev|testing|user|prod>"
    echo "duplo create <appType> <appName>        creates projects appType-<wp|docpad>"
    echo "duplo deploy:dev                        deploys app from current folder type to development server"
    echo "duplo deploy:testing                    deploys app from current folder type to testing server"
    echo "duplo deploy:prod <prod domains>        deploys app from current folder type to production server"
    echo "duplo deploy <git_url> <domain>         deploys app from current folder to custom place <git_url> -user@domain:project_name <domain> -for wp"
  ;;

esac
